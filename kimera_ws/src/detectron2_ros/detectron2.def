Bootstrap: docker
From: nvidia/cuda:11.3.0-cudnn8-devel-ubuntu20.04

%post
    apt-get update -y


    DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    git \
    build-essential \
    python3-dev \
    python3-pip \
    python3-setuptools \
    python3-opencv \
    curl

    pip3 -q install pip --upgrade

    pip3 install virtualenv

    pip install torch==1.10.0+cu102 torchvision==0.11.0+cu102 -f https://download.pytorch.org/whl/torch_stable.html

    pip3 install \
    jupyterlab \
    numpy \
    opencv-python  \
    Pillow \
    imageio \
    matplotlib \
    scikit-image \
    tqdm \
    ninja \
    yacs \
    cython \
    kornia \
    jupyter

    pip3 install detectron2 -f https://dl.fbaipublicfiles.com/detectron2/wheels/cu102/torch1.10/index.html

%setup
    touch /file_on_host
    touch ${SINGULARITY_ROOTFS}/file_on_guest

%files
    /file_on_host /opt

%environment
    export PORT=8889
    export LC_ALL=C


%startscript
    echo "Started new instance on $(date)"

%test
    grep -q NAME=\"Ubuntu\" /etc/os-release
    if [ $? -eq 0 ]; then
        echo "Container base is Ubuntu as expected."
    else
        echo "Container base is not Ubuntu."
    fi
    python3 -m pip show jupyter